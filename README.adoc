= Host Operator

image:https://goreportcard.com/badge/github.com/codeready-toolchain/host-operator[Go Report Card, link="https://goreportcard.com/report/github.com/codeready-toolchain/host-operator"]
image:https://godoc.org/github.com/codeready-toolchain/host-operator?status.png[GoDoc,link="https://godoc.org/github.com/codeready-toolchain/host-operator"]
image:https://codecov.io/gh/codeready-toolchain/host-operator/branch/master/graph/badge.svg[Codecov.io,link="https://codecov.io/gh/codeready-toolchain/host-operator"]

This is the CodeReady Toolchain Host Operator repository. It contains the OpenShift Operator that is deployed on the "host" cluster in the SaaS.

== Build

Requires Go version 1.12.6 - download for your development environment https://golang.org/dl/[here].

This repository uses https://github.com/golang/go/wiki/Modules[Go modules]. You may need to `export GO111MODULE=on` to turn modules support "on".

== Development

To run this operator locally you need to have at least one Minishift profile started:

```bash
$ minishift start --profile host
```

Then you can run the operator locally with the help of `operator-sdk`:

```bash
$ make up-local
```

That Makefile target takes care of additional several steps which can be executed separately:

* logging as system:admin user: `$ make login-as-admin`
* creating local test namespace: `$ make create-namespace`
* deploy CRDs: `$ make deploy-crd`
* building the project: `$ make build`
* deploying ClusterRole/ClusterRoleBinding and creating ServiceAccount: `$ make deploy-rbac`

There are a few more targets that you can find useful:

* to login as system:admin user and enter the local test namespace: `$ make use-namespace`
* to remove the local test namespace: `$ make clean-namespace`
* to remove & create the local test namespace, and create ClusterRole/ClusterRoleBinding and ServiceAccount inside of the namespace: `$ make reset-namespace`


=== End-to-End tests

==== Prerequisites if running locally on minishift
If you are running this tests locally on minishift, make sure that you have exposed minishift's docker-env, so that deployment can use locally built image. You can expose it by running following command.
`eval $(minishift docker-env)`


NOTE: This is not required for openshift-ci environment

==== Running End-to-End Tests
The `make test-e2e` will take care of creating a namespace/project with a random name (or see below for enforcing the namespace). It will also create all required CRDs, role and role binding for the service account, build the Docker image for the operator and push it to the OpenShift container registry. Finally, it will deploy the operator and run the tests using
the operator-sdk.


 NOTE: you can specify the namepace you want to use for running the end-to-end tests by writing its name in the `./build/_output/test-namespace` file. Otherwise, the file will be generated on the fly with a namespace in the form of `test-<UUID>`.

=== Verifying the OpenShift CI configuration

 It's possible to verify the OpenShift CI config from the developer's laptop while all the jobs are executed on the remote, online CI platform:

1. checkout and build the https://github.com/openshift/ci-tools[CI Operator] command line tool
2. login to https://console.svc.ci.openshift.org (via GH OAuth) and copy the login command (you may need to switch to the `application console`)
3. login with the command aferementioned
4. run the CI jobs with
+
```
ci-operator --config ../../openshift/release/ci-operator/config/codeready-toolchain/host-operator/codeready-toolchain-host-operator-master.yaml --git-ref=codeready-toolchain/host-operator@master
```

assuming that the https://github.com/openshift/release[OpenShift Release] repo was checked you.

NOTE: you can ignore the RBAC issues that are displayed in the console

=== Adding cluster to SaaS

The CodeReady Toolchain architecture contains two types of clusters `host` and `member`.
To connect these two clusters together it is necessary to run a script link:https://raw.githubusercontent.com/codeready-toolchain/toolchain-common/master/scripts/add-cluster.sh[add-cluster.sh] that is part of the link:https://github.com/codeready-toolchain/toolchain-common[toolchain-common] repository.
For more detailed information about the script see the link:https://github.com/codeready-toolchain/toolchain-common#add-clustersh[README "Script add-cluster.sh" chapter].

There are two Makefile targets available in this repository that execute the script:

*  `$ make add-member-to-host` that executes `../toolchain-common/scripts/add-cluster.sh member member-cluster`
*  `$ make add-host-to-member` that executes `../toolchain-common/scripts/add-cluster.sh host host-cluster`

NOTE: In order to run them, you need to have the link:https://github.com/codeready-toolchain/toolchain-common[toolchain-common] repository cloned to the same parent directory as this repository exists in.